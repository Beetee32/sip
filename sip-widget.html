<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Simple SIP Planner — Goal-driven</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#f7fafc;--card:#fff;--accent:#0b74de;--accent2:#0a5fb2;--muted:#6b7280;--success:#16a34a;--danger:#dc2626}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#0f172a}
  .wrap{max-width:1100px;margin:0 auto}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{display:block;font-size:13px;color:#111;margin-bottom:6px}
  input[type=number],select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
  .controls{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid #e6e9ef}
  .panel{background:#fbfdff;border-radius:10px;padding:12px;border:1px solid #eef3fb}
  .muted{color:var(--muted);font-size:13px}
  .result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:14px}
  .small{font-size:13px;color:#111}
  .kpi{font-size:16px;font-weight:700}
  .accent-text{color:var(--accent2);font-weight:700}
  .segmented{display:inline-flex;border-radius:10px;overflow:hidden;border:1px solid #e6e9ef}
  .segmented button{background:transparent;border:0;padding:8px 12px;cursor:pointer}
  .segmented button.active{background:var(--accent);color:#fff}
  .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
  .whatsapp{position:fixed;right:18px;bottom:18px;background:#25D366;color:#fff;padding:12px 14px;border-radius:999px;display:flex;gap:10px;align-items:center;box-shadow:0 8px 20px rgba(0,0,0,0.12);text-decoration:none;font-weight:700;z-index:9999}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tt{visibility:hidden;width:260px;background:#111;color:#fff;text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);font-size:12px;line-height:1.3}
  .tooltip:hover .tt{visibility:visible}
  .error{color:var(--danger);font-weight:700}
  .success{color:var(--success);font-weight:700}
  @media(max-width:600px){.header{flex-direction:column;align-items:flex-start}.controls{flex-direction:column;align-items:stretch}.charts{grid-template-columns:1fr}}
</style>
</head>
<body>
<a class="whatsapp" href="https://wa.me/917666123827" target="_blank" rel="noopener">Any doubts? Chat on WhatsApp</a>
<div class="wrap">
  <div class="header">
    <div><h1>Simple SIP Planner</h1><div class="sub">Goal-driven • Compare scenarios • Download Excel</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="downloadBtn" class="btn primary">Download Excel</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button id="tabPlanner" class="btn" style="font-weight:700">Planner</button>
      <button id="tabGoal" class="btn">Goal Planner</button>
    </div>

    <!-- Planner -->
    <div id="panePlanner">
      <div class="grid">
        <div><label for="husband">Husband monthly income (₹)</label><input id="husband" type="number" value="100000"></div>
        <div><label for="wife">Wife monthly income (₹)</label><input id="wife" type="number" value="100000"></div>
        <div><label for="house">Household expenses (₹)</label><input id="house" type="number" value="60000"></div>
        <div><label for="emi">EMI (₹)</label><input id="emi" type="number" value="20000"></div>
        <div><label for="misc">Misc expenses (₹)</label><input id="misc" type="number" value="20000"></div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid #eef3fb">

      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center">
        <div>
          <div style="margin-bottom:6px;font-weight:700">Allocation preset
            <span class="tooltip"><span class="tt">Conservative → more Large cap<br>Balanced → moderate risk<br>Aggressive → higher Mid/Small</span></span>
          </div>
          <div class="segmented">
            <button id="presetCons" class="seg-btn">Conservative</button>
            <button id="presetBal" class="seg-btn active">Balanced</button>
            <button id="presetAgg" class="seg-btn">Aggressive</button>
          </div>
        </div>
        <div style="min-width:320px">
          <label>Allocation (Large • Mid • Small %)</label>
          <div style="display:flex;gap:8px">
            <input id="lc" type="number" value="45" min="0" max="100" style="width:33.33%">
            <input id="mc" type="number" value="30" min="0" max="100" style="width:33.33%">
            <input id="sc" type="number" value="25" min="0" max="100" style="width:33.33%">
          </div>
          <div class="muted" style="margin-top:6px">Large • Mid • Small</div>
        </div>
      </div>

      <div class="controls">
        <div style="min-width:160px"><label for="years">Projection years</label>
          <select id="years">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
          </select>
        </div>
        <div style="min-width:120px"><label for="lc_r">Large cap CAGR %</label><input id="lc_r" type="number" value="9"></div>
        <div style="min-width:120px"><label for="mc_r">Mid cap CAGR %</label><input id="mc_r" type="number" value="12"></div>
        <div style="min-width:120px"><label for="sc_r">Small cap CAGR %</label><input id="sc_r" type="number" value="16"></div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div id="allocWarning" class="muted"></div>
          <button id="calc" class="btn primary">Calculate</button>
        </div>
      </div>

      <div id="plannerResults" class="result-grid"></div>
      <div class="charts">
        <div class="panel"><canvas id="allocChart" height="220"></canvas></div>
        <div class="panel"><canvas id="fvChart" height="220"></canvas></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div id="compareCards" style="display:flex;gap:12px;flex-wrap:wrap"></div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="manualCompare">
              <option value="">Compare with...</option>
              <option value="conservative">Conservative</option>
              <option value="balanced">Balanced</option>
              <option value="aggressive">Aggressive</option>
            </select>
            <button id="applyCompare" class="btn">Compare</button>
            <button id="applyComparisonToPlanner" class="btn ghost">Apply allocation</button>
          </div>
        </div>
        <div id="compareChartContainer" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Goal Planner -->
    <div id="paneGoal" style="display:none">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="min-width:200px"><label for="target">Target Corpus (₹)</label><input id="target" type="number" value="10000000"></div>
        <div style="min-width:120px"><label for="goalYears">Years to reach</label><input id="goalYears" type="number" value="15"></div>
        <div style="min-width:120px"><label for="goalCagr">Expected CAGR %</label><input id="goalCagr" type="number" value="12"></div>
        <div style="min-width:120px"><label for="goalInfl">Inflation % (annual)</label><input id="goalInfl" type="number" value="5"></div>
        <div style="align-self:end;display:flex;gap:8px">
          <button id="calcGoal" class="btn primary">Calculate Goal SIP</button>
          <button id="applyGoalToPlanner" class="btn ghost">Apply required SIP</button>
          <button id="useActualIncome" class="btn" style="display:none">Use actual income</button>
        </div>
      </div>
      <div id="goalResult" class="panel" style="margin-top:14px"></div>
      <div class="muted" style="margin-top:10px">Formula: SIP = FV × r / ((1+r)^n − 1) × (1+r)</div>
    </div>

    <div class="panel" style="margin-top:12px">
      <h4 style="margin:6px 0">Quick tips — why invest with us</h4>
      <ul style="margin:0 0 0 18px;color:var(--muted)">
        <li>Expert fund selection with disciplined risk controls</li>
        <li>Automatic SIPs enforce discipline and reduce timing risk</li>
        <li>Diversified Large/Mid/Small exposure for growth + resilience</li>
        <li>Low-cost investing + personalized guidance</li>
      </ul>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="font-weight:700">Golden rules</div>
      <div class="muted">
        <ul style="margin:0 0 0 18px">
          <li>Save first, spend later — automate SIPs</li>
          <li>Invest with a horizon; equities reward time</li>
          <li>Keep 6–12 months expenses as emergency fund</li>
          <li>Longer goals → higher Mid/Small exposure</li>
          <li>Rebalance annually, ignore short-term noise</li>
          <li>Define goal → timeline → required SIP</li>
          <li>Save your plan — a written plan works</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const $ = id => document.getElementById(id);

  // Indian number formatting
  function fmt(n, compact = false) {
    if (isNaN(n) || n === null) return "-";
    const abs = Math.abs(n);
    if (abs >= 10000000) return compact ? (n/10000000).toFixed(2)+" Cr" : "₹"+(n/10000000).toFixed(2)+" Cr";
    if (abs >= 100000) return compact ? (n/100000).toFixed(2)+" L" : "₹"+(n/100000).toFixed(2)+" L";
    return compact ? n.toLocaleString('en-IN') : "₹"+n.toLocaleString('en-IN');
  }

  // Future value of SIP
  function fvSIP(monthly, rate, years) {
    if (!monthly) return 0;
    const r = rate / 100 / 12;
    const n = years * 12;
    if (Math.abs(r) < 1e-12) return monthly * n;
    return monthly * ((Math.pow(1 + r, n) - 1) / r) * (1 + r);
  }

  // Required SIP for target
  function reqSIP(fv, cagr, years) {
    const r = cagr / 100 / 12;
    const n = years * 12;
    if (n <= 0) return NaN;
    if (Math.abs(r) < 1e-12) return fv / n;
    return fv * r / ((Math.pow(1 + r, n) - 1) * (1 + r));
  }

  const presets = {
    conservative: {lc:50, mc:30, sc:20},
    balanced:     {lc:45, mc:30, sc:25},
    aggressive:   {lc:35, mc:35, sc:30}
  };

  // Safe event binding
  function on(id, event, fn) {
    const el = $(id);
    if (el) el.addEventListener(event, fn);
  }

  // Tabs
  on('tabPlanner', 'click', () => { $('panePlanner').style.display = ''; $('paneGoal').style.display = 'none'; });
  on('tabGoal', 'click', () => { $('panePlanner').style.display = 'none'; $('paneGoal').style.display = ''; });

  // Presets
  function applyPreset(name) {
    const p = presets[name];
    if (!p) return;
    $('lc').value = p.lc; $('mc').value = p.mc; $('sc').value = p.sc;
    document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    $(`preset${name.charAt(0).toUpperCase() + name.slice(1)}`)?.classList.add('active');
    validateAlloc();
    renderPlanner();
  }
  on('presetCons', 'click', () => applyPreset('conservative'));
  on('presetBal', 'click', () => applyPreset('balanced'));
  on('presetAgg', 'click', () => applyPreset('aggressive'));

  // Allocation validation
  function validateAlloc() {
    const lc = +($('lc')?.value || 0);
    const mc = +($('mc')?.value || 0);
    const sc = +($('sc')?.value || 0);
    const sum = lc + mc + sc;
    const warn = $('allocWarning');
    if (!warn) return false;
    if (sum !== 100) {
      warn.innerHTML = `<span class="error">Must sum to 100% (current: ${sum}%)</span>`;
      return false;
    } else {
      warn.innerHTML = '<span class="success">100% ✓</span>';
      return true;
    }
  }

  // Attach input listeners safely
  ['lc','mc','sc'].forEach(id => {
    const el = $(id);
    if (el) el.addEventListener('input', validateAlloc);
  });

  // Get current state
  function getState() {
    const husband = +($('husband')?.value || 0);
    const wife = +($('wife')?.value || 0);
    const house = +($('house')?.value || 0);
    const emi = +($('emi')?.value || 0);
    const misc = +($('misc')?.value || 0);
    const income = husband + wife;
    const expense = house + emi + misc;
    const actualInvestable = Math.max(0, income - expense);
    const investable = window._appliedGoalSIP ?? actualInvestable;

    const lcPct = +($('lc')?.value || 0);
    const mcPct = +($('mc')?.value || 0);
    const scPct = +($('sc')?.value || 0);
    const years = +($('years')?.value || 15);
    const lcRate = +($('lc_r')?.value || 9);
    const mcRate = +($('mc_r')?.value || 12);
    const scRate = +($('sc_r')?.value || 16);

    const sipLC = investable * lcPct / 100;
    const sipMC = investable * mcPct / 100;
    const sipSC = investable * scPct / 100;

    const fvLC = fvSIP(sipLC, lcRate, years);
    const fvMC = fvSIP(sipMC, mcRate, years);
    const fvSC = fvSIP(sipSC, scRate, years);
    const totalFV = fvLC + fvMC + fvSC;

    return { income, expense, actualInvestable, investable, sipLC, sipMC, sipSC, fvLC, fvMC, fvSC, totalFV, years };
  }

  let charts = {};

  function renderCharts(state, compareState) {
    // Allocation pie
    if (charts.alloc) charts.alloc.destroy();
    charts.alloc = new Chart($('allocChart'), {
      type: 'pie',
      data: { labels: ['Large','Mid','Small'], datasets: [{ data: [+$('lc').value, +$('mc').value, +$('sc').value], backgroundColor: ['#0b74de','#0a5fb2','#ff7a59'] }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    // FV bar
    if (charts.fv) charts.fv.destroy();
    charts.fv = new Chart($('fvChart'), {
      type: 'bar',
      data: { labels: ['Large','Mid','Small'], datasets: [{ data: [state.fvLC, state.fvMC, state.fvSC], backgroundColor: ['#0b74de','#0a5fb2','#ff7a59'] }] },
      options: { plugins: { tooltip: { callbacks: { label: ctx => fmt(ctx.raw) } } } }
    });

    // Comparison
    if (compareState) {
      $('compareChartContainer').innerHTML = '<canvas id="compareChart" height="220"></canvas>';
      if (charts.compare) charts.compare.destroy();
      charts.compare = new Chart($('compareChart'), {
        type: 'bar',
        data: {
          labels: ['Large','Mid','Small'],
          datasets: [
            { label: 'Current', data: [state.fvLC, state.fvMC, state.fvSC], backgroundColor: '#0b74de' },
            { label: 'Compare', data: [compareState.fvLC, compareState.fvMC, compareState.fvSC], backgroundColor: '#ff7a59' }
          ]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    } else {
      $('compareChartContainer').innerHTML = '';
    }
  }

  function renderPlanner() {
    if (!validateAlloc()) {
      $('plannerResults').innerHTML = '<div class="panel error">Fix allocation to 100%</div>';
      return;
    }
    const s = getState();

    let html = `<div class="panel">
      <h3 style="margin:0 0 8px">Summary</h3>
      <div class="small">Income: <strong>${fmt(s.income)}</strong> | Expenses: <strong>${fmt(s.expense)}</strong></div>
      <div class="small">Investable: <strong>${fmt(s.investable)}</strong></div>
      <div class="small">Total SIP: <strong>${fmt(s.sipLC + s.sipMC + s.sipSC)}</strong></div>
      <div class="small">Projected in ${s.years} yrs: <strong>${fmt(s.totalFV)}</strong></div>
    </div>`;

    $('plannerResults').innerHTML = html;

    // Auto compare
    const currentAlloc = +$('lc').value;
    const suggested = currentAlloc > 47 ? 'aggressive' : 'balanced';
    const p = presets[suggested];
    const cmpInvestable = s.investable;
    const cmpFV = {
      fvLC: fvSIP(cmpInvestable * p.lc/100, +$('lc_r').value, s.years),
      fvMC: fvSIP(cmpInvestable * p.mc/100, +$('mc_r').value, s.years),
      fvSC: fvSIP(cmpInvestable * p.sc/100, +$('sc_r').value, s.years)
    };
    cmpFV.total = cmpFV.fvLC + cmpFV.fvMC + cmpFV.fvSC;

    $('compareCards').innerHTML = `
      <div class="panel"><strong>Current</strong><div>${fmt(s.totalFV)}</div></div>
      <div class="panel"><strong>${suggested.charAt(0).toUpperCase()+suggested.slice(1)}</strong><div>${fmt(cmpFV.total)}</div></div>
      <div class="panel" style="background:#fff8ec"><strong>Delta</strong><div>${fmt(cmpFV.total - s.totalFV)}</div></div>`;

    renderCharts(s, cmpFV);
  }

  on('calc', 'click', renderPlanner);
  on('applyCompare', 'click', () => {
    const sel = $('manualCompare').value;
    if (sel) applyPreset(sel);
  });
  on('applyComparisonToPlanner', 'click', () => {
    const sel = $('manualCompare').value;
    if (sel) applyPreset(sel);
  });

  on('calcGoal', 'click', () => {
    const target = +$('target').value;
    const years = +$('goalYears').value;
    const cagr = +$('goalCagr').value;
    const infl = +$('goalInfl').value;
    const requiredSIP = reqSIP(target, cagr, years);
    const todayValue = target / Math.pow(1 + infl/100, years);
    const current = getState().actualInvestable;

    $('goalResult').innerHTML = `
      <div class="small"><strong>Required SIP:</strong> ${fmt(requiredSIP)}</div>
      <div class="small"><strong>Today’s value of goal:</strong> ${fmt(todayValue)}</div>
      <div class="small"><strong>You can afford:</strong> ${current >= requiredSIP ? '<span class="success">Yes!</span>' : '<span class="error">Short by '+fmt(requiredSIP - current)+'</span>'}</div>`;

    window._lastGoalSIP = requiredSIP;
  });

  on('applyGoalToPlanner', 'click', () => {
    if (!window._lastGoalSIP) return alert("Calculate goal first");
    window._appliedGoalSIP = window._lastGoalSIP;
    $('useActualIncome').style.display = '';
    renderPlanner();
  });

  on('useActualIncome', 'click', () => {
    window._appliedGoalSIP = null;
    $('useActualIncome').style.display = 'none';
    renderPlanner();
  });

  on('resetBtn', 'click', () => {
    const defaults = {husband:100000,wife:100000,house:60000,emi:20000,misc:20000,lc:45,mc:30,sc:25,lc_r:9,mc_r:12,sc_r:16,years:15,target:10000000,goalYears:15,goalCagr:12,goalInfl:5};
    Object.keys(defaults).forEach(k => { const el = $(k); if (el) el.value = defaults[k]; });
    window._appliedGoalSIP = null;
    $('useActualIncome').style.display = 'none';
    document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    $('presetBal').classList.add('active');
    validateAlloc();
    renderPlanner();
  });

  on('downloadBtn', 'click', () => {
    const s = getState();
    const ws = XLSX.utils.aoa_to_sheet([
      ["SIP Planner Results"],[],
      ["Income",s.income],["Expenses",s.expense],["Investable",s.investable],
      [],["Large %", $('lc').value],["Mid %", $('mc').value],["Small %", $('sc').value],
      [],["Projected Corpus", s.totalFV]
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Plan");
    XLSX.writeFile(wb, "SIP-Plan.xlsx");
  });

  // Initial load
  validateAlloc();
  setTimeout(renderPlanner, 300);
});
</script>
</body>
</html>
