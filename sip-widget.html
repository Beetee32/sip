<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple SIP Planner — Goal-driven (fixed)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#f7fafc;--card:#fff;--accent:#0b74de;--accent-2:#0a5fb2;--muted:#6b7280;--success:#16a34a;--danger:#dc2626}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#0f172a}
  .wrap{max-width:1100px;margin:0 auto}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(11,16,30,0.06)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{display:block;font-size:13px;color:#111;margin-bottom:6px}
  input[type=number],select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
  .controls{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid #e6e9ef}
  .panel{background:#fbfdff;border-radius:10px;padding:12px;border:1px solid #eef3fb}
  .muted{color:var(--muted);font-size:13px}
  .result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:14px}
  .small{font-size:13px;color:#111}
  .kpi{font-size:16px;font-weight:700}
  .accent-text{color:var(--accent-2);font-weight:700}
  .segmented{display:inline-flex;border-radius:10px;overflow:hidden;border:1px solid #e6e9ef}
  .segmented button{background:transparent;border:0;padding:8px 12px;cursor:pointer}
  .segmented button.active{background:var(--accent);color:white}
  .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
  .whatsapp{position:fixed;right:18px;bottom:18px;background:#25D366;color:white;padding:12px 14px;border-radius:999px;display:flex;gap:10px;align-items:center;box-shadow:0 8px 20px rgba(0,0,0,0.12);text-decoration:none;font-weight:700;z-index:9999}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tt{visibility:hidden;width:260px;background:#111;color:#fff;text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);font-size:12px;line-height:1.3}
  .tooltip:hover .tt{visibility:visible}
  .error{color:var(--danger);font-weight:700}
  .success{color:var(--success);font-weight:700}
  @media (max-width:600px){.header{flex-direction:column;align-items:flex-start;gap:6px}.controls{flex-direction:column;align-items:stretch}.charts{grid-template-columns:1fr}}
</style>
</head>
<body>
  <a class="whatsapp" href="https://wa.me/917666123827" target="_blank" rel="noopener">Any doubts? Chat on WhatsApp</a>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Simple SIP Planner</h1>
        <div class="sub">Goal-driven planner • Compare scenarios • Download Excel</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="downloadBtn" class="btn primary">Download Excel</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div id="tabPlanner" class="btn" style="font-weight:700">Planner</div>
        <div id="tabGoal" class="btn">Goal Planner</div>
      </div>

      <!-- Planner Pane -->
      <div id="panePlanner">
        <div class="grid">
          <div><label for="husband">Husband monthly income (₹)</label><input id="husband" type="number" value="100000" min="0"/></div>
          <div><label for="wife">Wife monthly income (₹)</label><input id="wife" type="number" value="100000" min="0"/></div>
          <div><label for="house">Household expenses (₹)</label><input id="house" type="number" value="60000" min="0"/></div>
          <div><label for="emi">EMI (₹)</label><input id="emi" type="number" value="20000" min="0"/></div>
          <div><label for="misc">Misc expenses (₹)</label><input id="misc" type="number" value="20000" min="0"/></div>
        </div>
        <hr style="margin:14px 0;border:none;border-top:1px solid #eef3fb">
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center">
          <div>
            <div style="margin-bottom:6px;font-weight:700">Allocation preset</div>
            <div class="segmented">
              <button id="presetCons" class="seg-btn">Conservative</button>
              <button id="presetBal" class="seg-btn">Balanced</button>
              <button id="presetAgg" class="seg-btn">Aggressive</button>
            </div>
          </div>
          <div style="min-width:320px">
            <label style="display:block;margin-bottom:6px">Allocation (Large, Mid, Small %)</label>
            <div style="display:flex;gap:8px">
              <input id="lc" type="number" value="45" min="0" max="100" style="width:33.33%"/>
              <input id="mc" type="number" value="30" min="0" max="100" style="width:33.33%"/>
              <input id="sc" type="number" value="25" min="0" max="100" style="width:33.33%"/>
            </div>
            <div class="muted" style="margin-top:6px">Large • Mid • Small</div>
          </div>
        </div>
        <div style="margin-top:12px" class="controls">
          <div style="min-width:160px"><label for="years">Projection years</label>
            <select id="years"><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="5">5</option></select>
          </div>
          <div style="min-width:120px"><label for="lc_r">Large cap CAGR %</label><input id="lc_r" type="number" value="11"/></div>
          <div style="min-width:120px"><label for="mc_r">Mid cap CAGR %</label><input id="mc_r" type="number" value="13"/></div>
          <div style="min-width:120px"><label for="sc_r">Small cap CAGR %</label><input id="sc_r" type="number" value="15"/></div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <div id="allocWarning" class="muted"></div>
            <button id="calc" class="btn primary">Calculate</button>
          </div>
        </div>
        <div id="plannerResults" class="result-grid" aria-live="polite"></div>
        <div class="charts">
          <div class="panel"><canvas id="allocChart" height="220"></canvas></div>
          <div class="panel"><canvas id="fvChart" height="220"></canvas></div>
        </div>
        <div class="panel" style="margin-top:12px">
          <div id="compareTop" style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div id="compareCards" style="display:flex;gap:12px;align-items:center"></div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="manualCompare">
                <option value="">Compare with...</option>
                <option value="conservative">Conservative</option>
                <option value="balanced">Balanced</option>
                <option value="aggressive">Aggressive</option>
              </select>
              <button id="applyCompare" class="btn">Compare</button>
              <button id="applyComparisonToPlanner" class="btn ghost">Apply comparison allocation</button>
            </div>
          </div>
          <div id="compareChartContainer" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Goal Planner Pane -->
      <div id="paneGoal" style="display:none">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="min-width:200px"><label for="target">Target Corpus (₹)</label><input id="target" type="number" value="10000000" min="0"/></div>
          <div style="min-width:120px"><label for="goalYears">Years to reach</label><input id="goalYears" type="number" value="15" min="1"/></div>
          <div style="min-width:120px"><label for="goalCagr">Expected CAGR %</label><input id="goalCagr" type="number" value="12"/></div>
          <div style="min-width:120px"><label for="goalInfl">Inflation % (annual)</label><input id="goalInfl" type="number" value="5"/></div>
          <div style="align-self:end;display:flex;gap:8px">
            <button id="calcGoal" class="btn primary">Calculate Goal SIP</button>
            <button id="applyGoalToPlanner" class="btn ghost">Apply required SIP to Planner</button>
            <button id="useActualIncome" class="btn" style="display:none">Use actual income</button>
          </div>
        </div>
        <div id="goalResult" style="margin-top:14px" class="panel" aria-live="polite"></div>
      </div>

      <div style="margin-top:12px" class="panel">
        <h4 style="margin:6px 0">Quick tips — why invest in mutual funds with us</h4>
        <ul style="margin:0 0 0 18px;color:var(--muted)">
          <li>Experienced fund selection with disciplined risk controls.</li>
          <li>Automatic SIPs reduce timing risk and enforce discipline.</li>
          <li>Diversified exposure to Large, Mid and Small caps.</li>
          <li>Low-cost systematic investing and personalised advice.</li>
        </ul>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  'use strict';
  function $(id) { return document.getElementById(id); }
  function safeLog() { if (window.console) console.log.apply(console, arguments); }

  function formatIndian(n, compact = false) {
    if (n == null || isNaN(n)) return "-";
    const x = Math.abs(n);
    if (x >= 10000000) return compact ? (n/10000000).toFixed(2)+" Cr" : "₹ "+(n/10000000).toFixed(2)+" Cr";
    if (x >= 100000) return compact ? (n/100000).toFixed(2)+" L" : "₹ "+(n/100000).toFixed(2)+" L";
    return compact ? n.toLocaleString('en-IN') : "₹ "+n.toLocaleString('en-IN');
  }

  function fv_sip(monthly, rate, years) {
    monthly = Number(monthly) || 0; rate = Number(rate) || 0; years = Number(years) || 0;
    if (monthly <= 0) return 0;
    const r = rate/100/12, n = years*12;
    if (Math.abs(r) < 1e-12) return monthly * n;
    return monthly * ((Math.pow(1+r, n)-1)/r) * (1+r);
  }

  function required_sip_for_target(FV, cagr, years) {
    FV = Number(FV) || 0; const r = (Number(cagr)||0)/100/12, n = Number(years)*12;
    if (n <= 0) return NaN;
    if (Math.abs(r) < 1e-12) return FV/n;
    return FV * r / ((Math.pow(1+r, n)-1)*(1+r));
  }

  const presets = {
    conservative: {lc:60, mc:25, sc:15},
    balanced:     {lc:45, mc:30, sc:25},
    aggressive:   {lc:30, mc:40, sc:30}
  };

  // Tabs
  $('tabPlanner').onclick = () => { $('panePlanner').style.display=''; $('paneGoal').style.display='none'; };
  $('tabGoal').onclick     = () => { $('panePlanner').style.display='none'; $('paneGoal').style.display=''; };

  // Presets
  function applyPreset(p) {
    $('lc').value = p.lc; $('mc').value = p.mc; $('sc').value = p.sc;
    document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
    if (p===presets.conservative) $('presetCons').classList.add('active');
    if (p===presets.balanced)     $('presetBal').classList.add('active');
    if (p===presets.aggressive)   $('presetAgg').classList.add('active');
    validateAlloc(); renderPlanner();
  }
  $('presetCons').onclick = () => applyPreset(presets.conservative);
  $('presetBal').onclick   = () => applyPreset(presets.balanced);
  $('presetAgg').onclick   = () => applyPreset(presets.aggressive);
  $('presetBal').classList.add('active');

  function validateAlloc() {
    const sum = Number($('lc').value||0) + Number($('mc').value||0) + Number($('sc').value||0);
    const w = $('allocWarning');
    if (sum !== 100) { w.innerHTML = `<span class="error">Sum must be 100% (current: ${sum}%)</span>`; return false; }
    w.innerHTML = '<span class="success">Allocation 100% ✔</span>'; return true;
  }
  ['lc','mc','sc'].forEach(id => $(id).oninput = validateAlloc);

  function getPlannerState() {
    const income = Number($('husband').value||0) + Number($('wife').value||0);
    const exp = Number($('house').value||0) + Number($('emi').value||0) + Number($('misc').value||0);
    const actualInvestable = Math.max(0, income - exp);
    const investable = window._appliedGoalSIP ?? actualInvestable;
    const lc = Number($('lc').value||0), mc = Number($('mc').value||0), sc = Number($('sc').value||0);
    const years = Number($('years').value||10);
    const lc_r = Number($('lc_r').value||0), mc_r = Number($('mc_r').value||0), sc_r = Number($('sc_r').value||0);
    const lc_sip = investable * lc/100, mc_sip = investable * mc/100, sc_sip = investable * sc/100;
    const fv_lc = fv_sip(lc_sip, lc_r, years);
    const fv_mc = fv_sip(mc_sip, mc_r, years);
    const fv_sc = fv_sip(sc_sip, sc_r, years);
    return {investable, actualInvestable, lc_sip, mc_sip, sc_sip, fv_lc, fv_mc, fv_sc, fv_total: fv_lc+fv_mc+fv_sc, years};
  }

  let allocChart = null, fvChart = null, compareChart = null;
  function renderCharts(state, compareState) {
    try {
      // Allocation pie
      const aCtx = $('allocChart').getContext('2d');
      if (allocChart) allocChart.destroy();
      allocChart = new Chart(aCtx, {type:'pie', data:{labels:['Large','Mid','Small'], datasets:[{data:[Number($('lc').value),Number($('mc').value),Number($('sc').value)], backgroundColor:['#0b74de','#0a5fb2','#ff7a59']}]}, options:{plugins:{legend:{position:'bottom'}}}});

      // FV bar
      const fCtx = $('fvChart').getContext('2d');
      if (fvChart) fvChart.destroy();
      fvChart = new Chart(fCtx, {type:'bar', data:{labels:['Large','Mid','Small'], datasets:[{label:'Projected FV', data:[state.fv_lc,state.fv_mc,state.fv_sc], backgroundColor:['#0b74de','#0a5fb2','#ff7a59']}]},
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>v>=100000?(v/100000).toFixed(1)+'L':v}}}}});

      // Compare chart
      if (compareState) {
        $('compareChartContainer').innerHTML = '<canvas id="compareChart" height="220"></canvas>';
        const cCtx = $('compareChart').getContext('2d');
        if (compareChart) compareChart.destroy();
        compareChart = new Chart(cCtx, {type:'bar', data:{labels:['Large','Mid','Small'], datasets:[
          {label:'Current', data:[state.fv_lc,state.fv_mc,state.fv_sc], backgroundColor:'#0b74de'},
          {label:'Comparison', data:[compareState.fv_lc,compareState.fv_mc,compareState.fv_sc], backgroundColor:'#ff7a59'}
        ]}, options:{plugins:{legend:{position:'bottom'}}, scales:{y:{ticks:{callback:v=>v>=100000?(v/100000).toFixed(1)+'L':v}}}}});
      } else $('compareChartContainer').innerHTML = '';
    } catch(e) { safeLog('chart error', e); }
  }

  function renderPlanner() {
    if (!validateAlloc()) { $('plannerResults').innerHTML = '<div class="panel error">Fix allocation to 100%</div>'; return; }
    const s = getPlannerState();
    let html = `<div class="panel"><h3>Summary</h3>
      <div class="small">Investable: <strong>${formatIndian(s.investable)}</strong></div>
      <div class="small">Total SIP: <strong>${formatIndian(s.lc_sip + s.mc_sip + s.sc_sip)}</strong></div>
      <div class="small">Projected corpus (${s.years} yrs): <strong>${formatIndian(s.fv_total)}</strong></div></div>`;

    // Auto-compare logic
    const current = {lc:Number($('lc').value), mc:Number($('mc').value), sc:Number($('sc').value)};
    const diffs = {conservative: Math.abs(current.lc-60)+Math.abs(current.mc-25)+Math.abs(current.sc-15),
                   balanced: Math.abs(current.lc-45)+Math.abs(current.mc-30)+Math.abs(current.sc-25),
                   aggressive: Math.abs(current.lc-30)+Math.abs(current.mc-40)+Math.abs(current.sc-30)};
    let next = 'aggressive';
    if (diffs.conservative < diffs.balanced && diffs.conservative < diffs.aggressive) next = 'balanced';
    else if (diffs.balanced < diffs.aggressive) next = 'aggressive';

    const cp = presets[next];
    const compare = {
      fv_lc: fv_sip(s.investable*cp.lc/100, Number($('lc_r').value), s.years),
      fv_mc: fv_sip(s.investable*cp.mc/100, Number($('mc_r').value), s.years),
      fv_sc: fv_sip(s.investable*cp.sc/100, Number($('sc_r').value), s.years)
    };
    compare.fv_total = compare.fv_lc + compare.fv_mc + compare.fv_sc;
    const delta = compare.fv_total - s.fv_total;

    const cards = `<div class="panel"><strong>Current</strong><div>${formatIndian(s.fv_total)}</div></div>
      <div class="panel"><strong>${next.charAt(0).toUpperCase()+next.slice(1)}</strong><div>${formatIndian(compare.fv_total)}</div></div>
      <div class="panel" style="background:#fff8ec"><strong>Delta</strong><div>${delta>0?'+' : ''}${formatIndian(delta)}</div></div>`;
    $('compareCards').innerHTML = cards;

    $('plannerResults').innerHTML = html;
    renderCharts(s, compare);
    window._plannerState = {current: s, compare};
  }

  $('calc').onclick = renderPlanner;
  $('applyCompare').onclick = () => {
    const sel = $('manualCompare').value;
    if (!sel || !validateAlloc()) return;
    const p = presets[sel];
    $('lc').value = p.lc; $('mc').value = p.mc; $('sc').value = p.sc;
    validateAlloc(); renderPlanner();
  };
  $('applyComparisonToPlanner').onclick = () => {
    if (!window._plannerState?.compare) return;
    const p = presets[$('manualCompare').value || 'aggressive'];
    $('lc').value = p.lc; $('mc').value = p.mc; $('sc').value = p.sc;
    validateAlloc(); renderPlanner();
  };

  $('calcGoal').onclick = () => {
    const FV = Number($('target').value), y = Number($('goalYears').value), cagr = Number($('goalCagr').value), infl = Number($('goalInfl').value);
    if (y <= 0) { $('goalResult').innerHTML = '<div class="panel error">Years must be > 0</div>'; return; }
    const sip = required_sip_for_target(FV, cagr, y);
    const real = FV / Math.pow(1+infl/100, y);
    const html = `<div class="panel">
      <div class="small"><strong>Required SIP:</strong> ${formatIndian(sip)}</div>
      <div class="small"><strong>Target (today's ₹):</strong> ${formatIndian(real)}</div>
    </div>`;
    $('goalResult').innerHTML = html;
    window._goalState = {sip};
  };

  $('applyGoalToPlanner').onclick = () => {
    if (!window._goalState) return alert('Calculate goal first');
    window._appliedGoalSIP = window._goalState.sip;
    $('useActualIncome').style.display = '';
    renderPlanner();
  };
  $('useActualIncome').onclick = () => {
    window._appliedGoalSIP = null;
    $('useActualIncome').style.display = 'none';
    renderPlanner();
  };

  $('resetBtn').onclick = () => {
    const def = {husband:100000,wife:100000,house:60000,emi:20000,misc:20000,lc:45,mc:30,sc:25,lc_r:11,mc_r:13,sc_r:15,years:10,target:10000000,goalYears:15,goalCagr:12,goalInfl:5};
    Object.keys(def).forEach(k => { if($(k)) $(k).value = def[k]; });
    window._appliedGoalSIP = null;
    $('useActualIncome').style.display = 'none';
    $('presetBal').classList.add('active');
    document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
    $('presetBal').classList.add('active');
    validateAlloc(); renderPlanner();
  };

  $('downloadBtn').onclick = () => {
    const st = getPlannerState();
    const ws = XLSX.utils.aoa_to_sheet([
      ["Field","Value"],
      ["Investable",st.investable],["Total SIP",st.lc_sip+st.mc_sip+st.sc_sip],
      ["Projected Corpus",st.fv_total]
    ]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "SIP Plan");
    XLSX.writeFile(wb, "SIP-Plan.xlsx");
  };

  // Auto-save
  let saveTimer;
  document.querySelectorAll('input,select').forEach(el => el.oninput = () => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      const data = {};
      ['husband','wife','house','emi','misc','lc','mc','sc','lc_r','mc_r','sc_r','years','target','goalYears','goalCagr','goalInfl'].forEach(id => {
        if($(id)) data[id] = $(id).value;
      });
      localStorage.setItem('sip_saved', JSON.stringify(data));
    }, 800);
  });

  // Restore
  const saved = localStorage.getItem('sip_saved');
  if (saved) {
    const d = JSON.parse(saved);
    Object.keys(d).forEach(k => { if($(k)) $(k).value = d[k]; });
  }

  validateAlloc();
  setTimeout(renderPlanner, 150);
});
</script>
</body>
</html>
