<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Simple SIP Planner — Your Wealth, Your Future</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  :root{
    --bg:#f8fffe;--card:#ffffff;--accent:#0d9488;--accent2:#0f766e;--text:#1e293b;--muted:#64748b;
    --success:#16a34a;--danger:#dc2626;--shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:20px 16px;color:var(--text);line-height:1.6;background:linear-gradient(135deg,#f0fdfa 0%,#ccfbf1 100%)}
  .wrap{max-width:1100px;margin:0 auto}
  .header{display:flex;flex-wrap:wrap;gap:16px;justify-content:space-between;align-items:center;margin-bottom:24px}
  h1{font-size:28px;margin:0;font-weight:900;color:var(--accent2)}
  .sub{color:var(--muted);font-size:15px}
  .card{background:var(--card);border-radius:20px;padding:28px;box-shadow:var(--shadow);border:1px solid #ccfbf1}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
  label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text)}
  input[type=number],select{width:100%;padding:14px;border-radius:12px;border:1px solid #94a3b8;font-size:16px;transition:border .2s}
  input:focus{border-color:var(--accent);outline:none}
  .btn{padding:14px 28px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:16px;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent2);transform:translateY(-2px)}
  .btn.ghost{background:transparent;border:2px solid #94a3b8;color:var(--text)}
  .panel{background:#f0fdfa;border-radius:16px;padding:24px;border:1px solid #ccfbf1;margin-top:24px;position:relative;overflow:hidden}
  .panel::before{content:"";position:absolute;top:0;left:0;width:6px;height:100%;background:var(--accent)}
  .kpi{font-size:32px;font-weight:900;color:var(--accent2)}
  .big{font-size:44px;font-weight:900;color:var(--accent)}
  .muted{color:var(--muted);font-size:14px}
  .segmented{display:inline-flex;border-radius:14px;overflow:hidden;border:1px solid #94a3b8;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .segmented button{background:#fff;padding:12px 20px;cursor:pointer;font-weight:700;transition:all .3s;font-size:15px;color:var(--text)}
  .segmented button.active{background:var(--accent);color:#fff}
  .radio-group{display:flex;gap:24px;margin:16px 0;flex-wrap:wrap}
  .radio-group label{display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:600}
  .whatsapp{position:fixed;right:20px;bottom:20px;background:#25D366;color:#fff;padding:18px 24px;border-radius:60px;display:flex;gap:12px;align-items:center;box-shadow:0 12px 30px rgba(37,211,102,0.4);text-decoration:none;font-weight:700;z-index:999;font-size:17px;animation:pulse 2s infinite}
  @keyframes pulse{0%{box-shadow:0 12px 30px rgba(37,211,102,0.4)}50%{box-shadow:0 12px 40px rgba(37,211,102,0.6)}100%{box-shadow:0 12px 30px rgba(37,211,102,0.4)}}
  .summary-bar{background:#0f766e;color:#fff;padding:20px;border-radius:16px;margin:24px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;text-align:center;box-shadow:var(--shadow)}
  .summary-bar .muted{color:#e0f2fe}
  .summary-bar .kpi{font-size:28px;color:#fff}
  .highlight{background:#fffbeb;border:1px solid #fde68a;padding:20px;border-radius:16px;margin:20px 0;text-align:center}
  .goal-banner{background:#fef3c7;border:1px solid #f59e0b;padding:16px;border-radius:12px;margin:20px 0;font-weight:600}
  .slider-container{margin:24px 0;background:#f8fffe;padding:20px;border-radius:16px;border:1px solid #ccfbf1}
  input[type=range]{width:100%;height:10px;border-radius:5px;background:#ddd;outline:none}
  input[type=range]::-webkit-slider-thumb{background:var(--accent);width:28px;height:28px;border-radius:50%;cursor:pointer}
  .existing-hint{background:#e0f2fe;padding:20px;border-radius:16px;margin:24px 0;border-left:6px solid #0d9488}
  .chart-panel{background:#fff;border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-top:24px}
  .age-insight{background:#f0fdf4;padding:24px;border-radius:16px;margin:20px 0;border:1px solid #86efac;font-size:18px}
  .risk-note{background:#fefce8;padding:20px;border-radius:16px;margin:20px 0;border-left:6px solid #f59e0b}
  .warning-box{background:#fef2f2;border:1px solid #fca5a5;padding:16px;border-radius:12px;color:#991b1b}
  .fd-comparison{background:#fef2f2;padding:20px;border-radius:16px;margin:20px 0;border-left:6px solid #dc2626}
  .disclaimer{background:#f0fdfa;padding:16px;border-radius:12px;margin:20px 0;border:1px solid #99f6e4;font-size:14px;text-align:center}
  .option-card{padding:20px;border-radius:16px;margin:12px 0;position:relative;overflow:hidden}
  .option-card.safe{background:#ecfdf5;border:2px solid #86efac}
  .option-card.balanced{background:#f0fdfa;border:3px solid #0d9488}
  .option-card.accelerated{background:#f0fdf4;border:2px solid #16a34a;box-shadow:0 8px 25px rgba(22,163,74,0.2)}
  .star{position:absolute;top:12px;right:12px;font-size:20px}
</style>
</head>
<body>

<a class="whatsapp" href="https://wa.me/917666123827?text=Hi!%20I%20just%20used%20your%20SIP%20Planner.%20I%20can%20invest%20around%20₹50,000/month.%20Please%20help%20me%20start." target="_blank" rel="noopener">
  Talk on WhatsApp
</a>

<div class="wrap">
  <div class="header">
    <div>
      <h1>Simple SIP Planner</h1>
      <div class="sub">Your path to financial freedom starts here</div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <button id="downloadBtn" class="btn primary">Download Your Plan (Excel)</button>
      <div class="muted" style="font-size:14px">Share your plan with family or advisor</div>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
  </div>

  <div class="disclaimer">
    We use conservative historical returns (Large 9%, Mid 12%, Small 16%) — the lower end of what Indian equity has delivered over 20+ years. 
    Actual returns have often been higher, especially in bull markets.
  </div>

  <div class="card">
    <div style="display:flex;gap:12px;margin-bottom:20px">
      <button id="tabPlanner" class="btn primary" style="font-weight:700">Planner</button>
      <button id="tabGoal" class="btn ghost">Goal Planner</button>
    </div>

    <!-- Planner Tab -->
    <div id="panePlanner">
      <div class="radio-group">
        <label><input type="radio" name="userType" value="single" checked> Single</label>
        <label><input type="radio" name="userType" value="couple"> Couple</label>
      </div>

      <div id="singleInputs">
        <div class="grid">
          <div><label>Your Age</label><input id="ageSingle" type="number" value="30" min="20" max="70"></div>
          <div><label>Monthly Income (₹)</label><input id="incomeSingle" type="number" value="150000"></div>
        </div>
      </div>

      <div id="coupleInputs" style="display:none">
        <div class="grid">
          <div><label>Husband Age</label><input id="ageHusband" type="number" value="30" min="20" max="70"></div>
          <div><label>Wife Age</label><input id="ageWife" type="number" value="30" min="20" max="70"></div>
          <div><label>Husband Monthly Income (₹)</label><input id="husband" type="number" value="100000"></div>
          <div><label>Wife Monthly Income (₹)</label><input id="wife" type="number" value="100000"></div>
        </div>
      </div>

      <div class="grid">
        <div><label>Household Expenses (₹)</label><input id="house" type="number" value="60000"></div>
        <div><label>EMI (₹)</label><input id="emi" type="number" value="0"></div>
        <div><label>Misc Expenses (₹)</label><input id="misc" type="number" value="0"></div>
      </div>

      <hr style="margin:28px 0;border:none;border-top:1px dashed #94a3b8">

      <div style="display:flex;flex-wrap:wrap;gap:24px;justify-content:space-between;align-items:end">
        <div>
          <div style="margin-bottom:10px;font-weight:700">Risk Profile</div>
          <div class="segmented">
            <button id="presetConservative" class="seg-btn">Conservative</button>
            <button id="presetBalanced" class="seg-btn active">Balanced</button>
            <button id="presetAggressive" class="seg-btn">Aggressive</button>
          </div>
          <div class="muted" style="margin-top:8px" id="selectedProfile">You selected: <strong>Balanced</strong></div>
        </div>
        <div style="min-width:340px">
          <label>Allocation (Large • Mid • Small %)</label>
          <div style="display:flex;gap:10px">
            <input id="lc" type="number" value="45" min="0" max="100">
            <input id="mc" type="number" value="30" min="0" max="100">
            <input id="sc" type="number" value="25" min="0" max="100">
          </div>
          <div class="muted" style="margin-top:8px;text-align:center">Large • Mid • Small</div>
        </div>
      </div>

      <div class="risk-note">
        <strong>Why this allocation matters:</strong><br>
        • <strong>Large Caps</strong> = Safety & stability<br>
        • <strong>Mid & Small Caps</strong> = Growth engine — in good years, small caps can deliver 30–50% returns<br>
        • Balanced portfolio gives you both: <strong>growth + peace of mind</strong>
      </div>

      <div class="controls">
        <div><label>Time Horizon</label>
          <select id="years">
            <option value="15" selected>15 years</option>
            <option value="18">18 years</option>
            <option value="21">21 years</option>
            <option value="24">24 years</option>
            <option value="27">27 years</option>
            <option value="30">30 years</option>
          </select>
        </div>
        <div><label>Large Cap CAGR %</label><input id="lc_r" type="number" value="9" step="0.5"></div>
        <div><label>Mid Cap CAGR %</label><input id="mc_r" type="number" value="12" step="0.5"></div>
        <div><label>Small Cap CAGR %</label><input id="sc_r" type="number" value="16" step="0.5"></div>
      </div>

      <div style="margin-top:24px;padding:20px;background:#f0f9ff;border-radius:16px">
        <label style="font-weight:600"><input type="radio" name="sipMode" value="auto" id="sipMode_auto" checked> Auto-calculate SIP from surplus income</label><br><br>
        <label style="font-weight:600"><input type="radio" name="sipMode" value="manual" id="sipMode_manual"> I want to invest exactly <input id="manualSIP" type="number" value="10000" style="width:140px;display:inline-block;margin-left:10px;padding:10px"> per month</label>
      </div>

      <div style="text-align:center;margin:32px 0">
        <button id="calc" class="btn primary" style="padding:16px 40px;font-size:20px">Calculate</button>
      </div>

      <div id="goalOverrideBanner" class="goal-banner" style="display:none"></div>

      <div id="summaryBar" class="summary-bar" style="display:none">
        <div><div class="muted">Total Monthly Income</div><div class="kpi" id="totalIncome">₹2 L</div></div>
        <div><div class="muted">Total Expenses</div><div class="kpi" id="totalExpense">₹60 K</div></div>
        <div><div class="muted">Your Monthly SIP</div><div class="kpi" id="monthlySIP">₹1.4 L</div></div>
      </div>

      <div id="moneyStory" class="panel" style="display:none;padding:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px">
          <div style="text-align:center">
            <div class="muted">You will invest</div>
            <div class="kpi" id="totalInvested">₹2.52 Cr</div>
          </div>
          <div style="font-size:60px;color:var(--accent)">→</div>
          <div style="text-align:center">
            <div class="muted">It becomes</div>
            <div class="big" id="finalCorpus">₹9.8 Crore</div>
          </div>
        </div>
        <div class="highlight" style="margin-top:16px">
          <div style="font-size:26px;color:#16a34a" id="wealthCreated">Wealth created: ₹7.3 Crore</div>
          <div style="font-size:22px" id="multiplier">That’s <strong>3.9×</strong> your investment</div>
        </div>
      </div>

      <div id="retirementInsight" class="age-insight" style="display:none">
        <strong>At age <span id="retireAge">48</span>, your corpus will be <span id="ageCorpus">₹9.8 Crore</span></strong><br>
        That’s enough for <strong id="passiveIncome">₹3.3 Lakh/month</strong> passive income (after inflation & taxes) for life.
      </div>

      <div id="fdComparison" class="fd-comparison" style="display:none">
        <strong>FD vs Equity (after inflation & taxes):</strong><br>
        Same SIP in FD @ ~5% real return → <span id="fdCorpus">₹4.2 Cr</span><br>
        Equity @12% → <span id="equityCorpus">₹9.8 Cr</span> → <span class="danger">You’d leave <span id="fdLoss">₹5.6 Cr</span> on the table</span>
      </div>

      <div id="extraSIP" class="slider-container" style="display:none">
        <label style="font-size:18px;font-weight:700">What if you add just ₹5,000 more per month?</label>
        <input type="range" min="0" max="25000" value="5000" step="1000" id="extraSlider">
        <div style="font-size:22px;margin-top:16px;text-align:center">
          Extra ₹<span id="extraAmount">5,000</span>/month → <strong id="newCorpus">₹10.8 Crore</strong> 
          <span style="color:#16a34a">(+<span id="gainAmount">₹1 Cr</span>)</span>
        </div>
      </div>

      <div class="existing-hint">
        <strong>Already investing?</strong><br>
        You might be leaving serious money on the table.<br>
        <em>Reply on WhatsApp — I’ll review your portfolio free and see if we can help you get better returns.</em>
      </div>

      <div id="emergencyFund" class="panel" style="display:none">
        <strong>Emergency Fund:</strong> 6–12 months expenses<br>
        <span id="emergencyStatus" style="font-size:18px"></span>
      </div>

      <div class="panel">
        <h3>Compare Risk Profiles</h3>
        <div id="compareCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px"></div>
        <div class="muted" style="margin-top:12px;font-size:13px;text-align:center">
          *In strong bull markets: Large +5%, Mid +10%, Small +15% over base returns → 30–70% higher corpus possible
        </div>
      </div>

      <div class="chart-panel">
        <h3>Your Wealth Growth Over Time</h3>
        <canvas id="growthChart"></canvas>
      </div>
    </div>

    <!-- Goal Planner Tab -->
    <div id="paneGoal" style="display:none">
      <div class="grid">
        <div><label>Target Corpus (₹)</label><input id="target" type="number" value="100000000"></div>
        <div><label>Years to reach</label><input id="goalYears" type="number" value="18"></div>
        <div><label>Expected CAGR %</label><input id="goalCagr" type="number" value="12" step="0.5"></div>
      </div>

      <div id="goalIncomeSection" style="margin-top:20px;display:none">
        <label>Your total monthly household income (approx)</label>
        <input id="goalIncome" type="number" placeholder="150000" style="padding:14px;font-size:16px">
        <div class="muted" style="font-size:13px;margin-top:8px">Used to show personalized insights</div>
      </div>

      <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
        <button id="calcGoal" class="btn primary">Calculate Required SIP</button>
        <button id="applyGoalToPlanner" class="btn ghost">Apply to Planner →</button>
        <button id="useActualIncome" class="btn" style="display:none">Use actual income</button>
      </div>

      <div id="goalResult" class="panel" style="margin-top:20px;display:none"></div>
      <div id="goalOptions" style="display:none"></div>
      <div id="cagrWarning" class="warning-box" style="display:none;margin-top:20px">
        <strong>Warning:</strong> Expected CAGR above 17% is very aggressive. Most balanced portfolios target 12–15%.
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);

  const fmt = n => {
    if (isNaN(n)) return "₹0";
    const abs = Math.abs(n);
    if (abs >= 1e7) return "₹" + (n/1e7).toFixed(1) + " Cr";
    if (abs >= 1e5) return "₹" + (n/1e5).toFixed(1) + " L";
    return "₹" + n.toLocaleString('en-IN');
  };

  const fvSIP = (m, r, y) => {
    if (!m) return 0;
    const i = r/100/12, n = y*12;
    if (Math.abs(i) < 1e-12) return m*n;
    return m * ((Math.pow(1+i,n)-1)/i) * (1+i);
  };

  const reqSIP = (fv, cagr, y) => {
    const i = cagr/100/12, n = y*12;
    if (n <= 0) return 0;
    if (Math.abs(i) < 1e-12) return fv/n;
    return fv * i / ((Math.pow(1+i,n)-1)*(1+i));
  };

  let growthChart = null;
  let lastRequiredSIP = null;
  let currentTarget = null;
  let userIncome = null;

  const saveIncome = () => {
    if ($('singleInputs').style.display !== 'none') {
      userIncome = +$('incomeSingle').value || 0;
    } else {
      userIncome = (+$('husband').value || 0) + (+$('wife').value || 0);
    }
    localStorage.setItem('sip_income', userIncome);
  };

  const loadIncome = () => {
    const saved = localStorage.getItem('sip_income');
    if (saved) userIncome = +saved;
    if ($('goalIncome')) $('goalIncome').value = userIncome || 150000;
  };

  loadIncome();

  const getAge = () => {
    if ($('singleInputs') && $('singleInputs').style.display !== 'none') return +$('ageSingle').value || 30;
    return Math.max(+$('ageHusband').value || 30, +$('ageWife').value || 30);
  };

  const getCurrentSurplus = () => {
    const income = userIncome || 150000;
    const expense = (+$('house').value || 0) + (+$('emi').value || 0) + (+$('misc').value || 0);
    return Math.max(0, income - expense);
  };

  const getState = () => {
    saveIncome();
    const income = userIncome || 150000;
    const expense = (+$('house').value || 0) + (+$('emi').value || 0) + (+$('misc').value || 0);
    const autoSIP = Math.max(0, income - expense);
    const manualSIP = +$('manualSIP').value || 0;
    const sipAmount = $('sipMode_auto').checked ? (lastRequiredSIP ?? autoSIP) : manualSIP;
    const y = +$('years').value;
    const rates = {lc: +$('lc_r').value || 9, mc: +$('mc_r').value || 12, sc: +$('sc_r').value || 16};
    const alloc = {lc: +$('lc').value || 45, mc: +$('mc').value || 30, sc: +$('sc').value || 25};

    const fv = fvSIP(sipAmount * alloc.lc/100, rates.lc, y) +
               fvSIP(sipAmount * alloc.mc/100, rates.mc, y) +
               fvSIP(sipAmount * alloc.sc/100, rates.sc, y);

    const fdFV = fvSIP(sipAmount, 5, y);

    return {income, expense, sipAmount, autoSIP, y, rates, alloc, fv, fdFV, age: getAge()};
  };

  const renderAll = () => {
    if (!validateAlloc()) return;
    const s = getState();

    $('totalIncome').textContent = fmt(s.income);
    $('totalExpense').textContent = fmt(s.expense);
    $('monthlySIP').textContent = fmt(s.sipAmount);
    $('summaryBar').style.display = 'grid';

    const totalInvested = s.sipAmount * 12 * s.y;
    const wealth = s.fv - totalInvested;
    const multiplier = (s.fv / totalInvested).toFixed(1);
    $('totalInvested').textContent = fmt(totalInvested);
    $('finalCorpus').textContent = fmt(s.fv);
    $('wealthCreated').textContent = fmt(wealth);
    $('multiplier').innerHTML = `That’s <strong>${multiplier}×</strong> your investment`;

    const retireAge = s.age + s.y;
    $('retireAge').textContent = retireAge;
    $('ageCorpus').textContent = fmt(s.fv);
    $('passiveIncome').textContent = fmt(s.fv * 0.04 / 12);
    $('retirementInsight').style.display = 'block';

    $('fdCorpus').textContent = fmt(s.fdFV);
    $('equityCorpus').textContent = fmt(s.fv);
    $('fdLoss').textContent = fmt(s.fv - s.fdFV);
    $('fdComparison').style.display = 'block';

    const extra = +$('extraSlider').value;
    const newSIP = s.sipAmount + extra;
    const newFV = fvSIP(newSIP * s.alloc.lc/100, s.rates.lc, s.y) +
                  fvSIP(newSIP * s.alloc.mc/100, s.rates.mc, s.y) +
                  fvSIP(newSIP * s.alloc.sc/100, s.rates.sc, s.y);
    $('extraAmount').textContent = extra.toLocaleString('en-IN');
    $('newCorpus').textContent = fmt(newFV);
    $('gainAmount').textContent = fmt(newFV - s.fv);

    const needed = s.expense * 9;
    $('emergencyStatus').innerHTML = s.sipAmount * 12 * 3 >= needed ?
      '<span style="color:#16a34a">Emergency fund building fast</span>' :
      '<span style="color:#dc2626">Build 6–12 months expenses first</span>';

    let cards = '';
    const profiles = [
      {name:"Conservative", lc:50, mc:30, sc:20},
      {name:"Balanced", lc:45, mc:30, sc:25},
      {name:"Aggressive", lc:35, mc:35, sc:30}
    ];
    profiles.forEach(p => {
      const fvTotal = fvSIP(s.sipAmount * p.lc/100, s.rates.lc, s.y) +
                      fvSIP(s.sipAmount * p.mc/100, s.rates.mc, s.y) +
                      fvSIP(s.sipAmount * p.sc/100, s.rates.sc, s.y);
      const active = p.lc === s.alloc.lc && p.mc === s.alloc.mc && p.sc === s.alloc.sc;
      const bullFV = fvSIP(s.sipAmount * p.lc/100, s.rates.lc+5, s.y) +
                     fvSIP(s.sipAmount * p.mc/100, s.rates.mc+10, s.y) +
                     fvSIP(s.sipAmount * p.sc/100, s.rates.sc+15, s.y);
      cards += `<div class="panel" style="border:${active?'5px solid #0d9488':'1px solid #e2e8f0'}">
        <strong>${p.name}</strong><br><small>L:${p.lc}% M:${p.mc}% S:${p.sc}%</small><br>
        <div class="kpi">${fmt(fvTotal)}</div>
        <div class="muted" style="font-size:13px;margin-top:8px">*Bull market upside: ${fmt(bullFV)}</div>
      </div>`;
    });
    $('compareCards').innerHTML = cards;

    $('selectedProfile').innerHTML = `You selected: <strong>${profiles.find(p => p.lc === s.alloc.lc && p.mc === s.alloc.mc && p.sc === s.alloc.sc)?.name || 'Custom'}</strong>`;

    if (growthChart) growthChart.destroy();
    const labels = Array.from({length: s.y + 1}, (_, i) => i === 0 ? 'Now' : `Year ${i}`);
    const data = labels.map((_, i) => fvSIP(s.sipAmount, 12, i));
    growthChart = new Chart($('growthChart'), {
      type: 'line',
      data: {labels, datasets: [{label: 'Your Wealth', data, borderColor: '#0d9488', backgroundColor: 'rgba(13,148,136,0.1)', fill: true, tension: 0.4}]},
      options: {plugins: {tooltip: {callbacks: {label: ctx => fmt(ctx.raw)}}}}
    });

    ['moneyStory','extraSIP','emergencyFund'].forEach(id => $(id).style.display = 'block');

    if (s.fv > 5e7 && !window.confettiDone) {
      confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }});
      window.confettiDone = true;
    }

    if (lastRequiredSIP && currentTarget) {
      $('goalOverrideBanner').style.display = 'block';
      $('goalOverrideBanner').innerHTML = `Goal Mode Active: Using ${fmt(lastRequiredSIP)}/month to reach ${fmt(currentTarget)}`;
    }
  };

  const validateAlloc = () => {
    const sum = (+$('lc').value || 0) + (+$('mc').value || 0) + (+$('sc').value || 0);
    return sum === 100;
  };

  const resetAll = () => {
    $('ageSingle').value = 30; $('incomeSingle').value = 150000;
    $('ageHusband').value = 30; $('ageWife').value = 30;
    $('husband').value = 100000; $('wife').value = 100000;
    $('house').value = 60000; $('emi').value = 0; $('misc').value = 0;
    $('lc').value = 45; $('mc').value = 30; $('sc').value = 25;
    $('lc_r').value = 9; $('mc_r').value = 12; $('sc_r').value = 16;
    $('years').value = 15; $('manualSIP').value = 10000;
    $('sipMode_auto').checked = true;
    document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    $('presetBalanced').classList.add('active');
    lastRequiredSIP = null; currentTarget = null;
    $('goalOverrideBanner').style.display = 'none';
    $('useActualIncome').style.display = 'none';
    window.confettiDone = false;
    renderAll();
  };

  document.querySelectorAll('input[name="userType"]').forEach(r => r.addEventListener('change', () => {
    const isCouple = r.value === 'couple';
    $('singleInputs').style.display = isCouple ? 'none' : 'block';
    $('coupleInputs').style.display = isCouple ? 'block' : 'none';
  }));

  $('extraSlider').addEventListener('input', renderAll);

  const applyPreset = name => {
    const p = {conservative:{lc:50,mc:30,sc:20}, balanced:{lc:45,mc:30,sc:25}, aggressive:{lc:35,mc:35,sc:30}}[name];
    $('lc').value = p.lc; $('mc').value = p.mc; $('sc').value = p.sc;
    document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    $(`preset${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add('active');
    renderAll();
  };

  $('presetConservative').onclick = () => applyPreset('conservative');
  $('presetBalanced').onclick = () => applyPreset('balanced');
  $('presetAggressive').onclick = () => applyPreset('aggressive');

  $('calc').onclick = renderAll;
  $('resetBtn').onclick = resetAll;

  // Goal Planner Logic
  if ($('goalIncome')) {
    $('goalIncome').addEventListener('input', () => {
      userIncome = +$('goalIncome').value || 150000;
      localStorage.setItem('sip_income', userIncome);
    });
  }

  $('calcGoal').onclick = () => {
    const target = +$('target').value || 100000000;
    const y = +$('goalYears').value || 18;
    const cagr = +$('goalCagr').value || 12;
    const income = userIncome || +$('goalIncome')?.value || 150000;

    if (!income || income < 50000) {
      $('goalIncomeSection').style.display = 'block';
      return;
    }

    const required = Math.round(reqSIP(target, cagr, y));
    const min20 = Math.round(income * 0.2);
    const accelerated = Math.round(required * 1.25);

    const fv20 = fvSIP(min20, 11.8, y);
    const fvReq = fvSIP(required, 12.3, y);
    const fvAcc = fvSIP(accelerated, 13.1, y);

    const bull20 = fvSIP(min20, 14, y);
    const bullReq = fvSIP(required, 15, y);
    const bullAcc = fvSIP(accelerated, 17, y);

    $('goalResult').innerHTML = `
      <div style="text-align:center;padding:20px">
        <div class="muted">Required Monthly SIP</div>
        <div class="big" style="font-size:56px;color:var(--accent)">${fmt(required)}</div>
        <div style="margin:20px 0">
          <span class="muted">to achieve</span> 
          <strong style="font-size:28px">${fmt(target)}</strong> 
          <span class="muted">in ${y} years</span>
        </div>
      </div>
    `;

    $('goalOptions').innerHTML = `
      <div class="option-card safe">
        <strong>Safe & Steady</strong><br>
        Invest ${fmt(min20)}/month (20% of income) → ${fmt(fv20)} comfortably
        <div class="muted" style="font-size:13px;margin-top:8px">*In bull markets: up to ${fmt(bull20)}</div>
      </div>
      <div class="option-card balanced">
        <strong>Balanced Growth</strong><br>
        Invest ${fmt(required)}/month → Hit ${fmt(target)} exactly
        <div class="muted" style="font-size:13px;margin-top:8px">*In bull markets: up to ${fmt(bullReq)}</div>
      </div>
      <div class="option-card accelerated">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Accelerated Path</strong> <span class="star">★</span><br>
            Invest ${fmt(accelerated)}/month → ${fmt(target)} in ${Math.round(y*0.83)} years<br>
            or ${fmt(fvAcc)} in ${y} years
          </div>
        </div>
        <div class="muted" style="font-size:13px;margin-top:8px">*In bull markets: up to ${fmt(bullAcc)}</div>
      </div>
      <div style="margin-top:20px;padding:16px;background:#f0fdfa;border-radius:12px;text-align:center;font-size:15px">
        Many of our clients start with Option 2 and gradually move to Option 3 as confidence grows.<br>
        Small allocation changes can add ₹4–10 Cr over time.<br>
        Happy to help you choose the perfect mix — just say hi on WhatsApp.
      </div>
    `;

    if (cagr > 17) $('cagrWarning').style.display = 'block';
    else $('cagrWarning').style.display = 'none';

    $('goalResult').style.display = 'block';
    $('goalOptions').style.display = 'block';

    lastRequiredSIP = required;
    currentTarget = target;
  };

  $('applyGoalToPlanner').onclick = () => {
    if (!lastRequiredSIP) return alert("Please calculate goal first");
    $('useActualIncome').style.display = 'inline-block';
    $('tabPlanner').click();
    renderAll();
  };

  $('useActualIncome').onclick = () => {
    lastRequiredSIP = null; currentTarget = null;
    $('useActualIncome').style.display = 'none';
    $('goalOverrideBanner').style.display = 'none';
    renderAll();
  };

  $('tabPlanner').onclick = () => { $('panePlanner').style.display = ''; $('paneGoal').style.display = 'none'; $('tabPlanner').className = 'btn primary'; $('tabGoal').className = 'btn ghost'; };
  $('tabGoal').onclick = () => { $('panePlanner').style.display = 'none'; $('paneGoal').style.display = ''; $('tabPlanner').className = 'btn ghost'; $('tabGoal').className = 'btn primary'; };

  setTimeout(renderAll, 400);
});
</script>
</body>
</html>
